<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=hugo-theme content="Axiom 0.6.8"><link rel=icon type=image/png sizes=32x32 href=/image/brand/favicon.png><link rel=icon type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon href=/image/brand/icon-1-1.png><link rel=canonical href=https://pdxjohnny.github.io/post/linux-kernel/><link rel=preload as=style href="/bundle.css?v=1595572978" media=all><link rel=stylesheet href="/bundle.css?v=1595572978" media=all><style>.cdata pre{color:#edf2f7;background-color:#2d3748}.cdata :not(pre)>code{color:#805ad5;background-color:#f7fafc}.chroma .err{color:#fed7d7;background-color:#9b2c2c}.chroma .hl{background-color:#4a5568}.chroma .ln{color:#a0aec0}.chroma .k,.chroma .kc,.chroma .kd,.chroma .kn,.chroma .kp,.chroma .kr{color:#63b3ed}.chroma .kt{color:#b794f4}.chroma .na{color:#f6e05e}.chroma .nb{color:#f6ad55}.chroma .nc{color:#fc8181}.chroma .no{color:#68d391}.chroma .nd{color:#fc8181}.chroma .ne{color:#fc8181}.chroma .nf{color:#f6ad55}.chroma .nt{color:#fc8181}.chroma .l{color:#b794f4}.chroma .dl,.chroma .ld,.chroma .s,.chroma .s2,.chroma .sa,.chroma .sb,.chroma .sc,.chroma .sd{color:#68d391}.chroma .se{color:#a0aec0}.chroma .s1,.chroma .sh,.chroma .si,.chroma .sr,.chroma .ss,.chroma .sx{color:#68d391}.chroma .il,.chroma .m,.chroma .mb,.chroma .mf,.chroma .mh,.chroma .mi,.chroma .mo{color:#b794f4}.chroma .o,.chroma .ow{color:#90cdf4}.chroma .p{color:#cbd5e0}.chroma .c,.chroma .c1,.chroma .ch,.chroma .cm,.chroma .cp,.chroma .cpf,.chroma .cs{color:#a0aec0}.chroma .ge{font-style:italic}.chroma .gs{font-weight:700}</style><title>Linux Kernel Tips And Tricks : pdxjohnny's blog</title><meta property="og:title" content="Linux Kernel Tips And Tricks"><meta property="og:site_name" content="pdxjohnny's blog"><meta property="og:url" content="https://pdxjohnny.github.io/post/linux-kernel/"><link rel=image_src href=https://pdxjohnny.github.io/image/page-default.webp><meta property="og:image" content="https://pdxjohnny.github.io/image/page-default.webp"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="og:type" content="article"><meta property="og:locale" content="en_us"><meta property="og:description" content="Debugging Core dumps and kgdb: https://elinux.org/images/f/f0/Bingham.pdf Exploitation SMEP disable via ROP, KASLR bypasss via DMESG https://web.archive.org/web/20171029060939/http://www.blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/ Hacking With VIM https://stackoverflow.com/questions/33676829/vim-configuration-for-linux-kernel-development Build In Tree Modules make -j $(($(nproc)*4)) M=arch/x86/kvm/ modules Install Kernel To chroot Here's how you install a kernel to a chroot."><meta name=description content="Debugging Core dumps and kgdb: https://elinux.org/images/f/f0/Bingham.pdf Exploitation SMEP disable via ROP, KASLR bypasss via DMESG https://web.archive.org/web/20171029060939/http://www.blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/ Hacking With VIM https://stackoverflow.com/questions/33676829/vim-configuration-for-linux-kernel-development Build In Tree Modules make -j $(($(nproc)*4)) M=arch/x86/kvm/ modules Install Kernel To chroot Here's how you install a kernel to a chroot."><meta property="og:updated_time" content="2020-07-24T06:00:00Z"><meta property="fb:app_id" content><meta name=author content="John Andersen"><meta property="article:author" content="https://pdxjohnny.github.io/"><meta property="article:published_time" content="2020-07-24T06:00:00Z"><meta property="article:modified_time" content="2020-07-24T06:00:00Z"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"Linux Kernel Tips And Tricks","alternativeHeadline":"Working on the Linux kernel itself","url":"https://pdxjohnny.github.io/post/linux-kernel/","image":"https://pdxjohnny.github.io/image/page-default.webp","mainEntityOfPage":{"@type":"WebPage","@id":"https://pdxjohnny.github.io/post/linux-kernel/"},"description":"Debugging Core dumps and kgdb: https://elinux.org/images/f/f0/Bingham.pdf Exploitation SMEP disable via ROP, KASLR bypasss via DMESG https://web.archive.org/web/20171029060939/http://www.blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/ Hacking With VIM https://stackoverflow.com/questions/33676829/vim-configuration-for-linux-kernel-development Build In Tree Modules make -j $(($(nproc)*4)) M=arch/x86/kvm/ modules Install Kernel To chroot Here's how you install a kernel to a chroot.","author":{"@type":"Person","name":"John Andersen"},"publisher":{"@type":"Organization","name":"pdxjohnny's blog","logo":{"@type":"ImageObject","url":"https://pdxjohnny.github.io/image/brand/icon-1-1.png"}},"datePublished":"2020-07-24T06:00:00Z","dateModified":"2020-07-24T06:00:00Z","articleBody":"\u003ch2 id=\"debugging\"\u003eDebugging\u003c/h2\u003e\n\u003cp\u003eCore dumps and kgdb: \u003ca href=\"https://elinux.org/images/f/f0/Bingham.pdf\"\u003ehttps://elinux.org/images/f/f0/Bingham.pdf\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"exploitation\"\u003eExploitation\u003c/h2\u003e\n\u003cp\u003eSMEP disable via ROP, KASLR bypasss via DMESG\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://web.archive.org/web/20171029060939/http://www.blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/\"\u003ehttps://web.archive.org/web/20171029060939/http://www.blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"hacking-with-vim\"\u003eHacking With VIM\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://stackoverflow.com/questions/33676829/vim-configuration-for-linux-kernel-development\"\u003ehttps://stackoverflow.com/questions/33676829/vim-configuration-for-linux-kernel-development\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"build-in-tree-modules\"\u003eBuild In Tree Modules\u003c/h2\u003e\n\u003cpre\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003emake -j $(($(nproc)*4)) M=arch/x86/kvm/ modules\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"install-kernel-to-chroot\"\u003eInstall Kernel To chroot\u003c/h2\u003e\n\u003cp\u003eHere's how you install a kernel to a chroot. Or tar it up and\nsend it over to another system for use there.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"c1\"\u003e# Edit your config\u003c/span\u003e\nmake olddefconfig\n\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eINSTALL_MOD_PATH\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/path/to/your/chroot\n\u003cspan class=\"nb\"\u003eexport\u003c/span\u003e \u003cspan class=\"nv\"\u003eINSTALL_PATH\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eINSTALL_MOD_PATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e/boot\nmkdir -p \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eINSTALL_PATH\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# Use number of cores times 4, this usually is about how many\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# threads your system can run\u003c/span\u003e\nmake -j \u003cspan class=\"k\"\u003e$(($(\u003c/span\u003enproc\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"k\"\u003e))\u003c/span\u003e\nmake install\nmake modules_install -j \u003cspan class=\"k\"\u003e$(($(\u003c/span\u003enproc\u003cspan class=\"k\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"m\"\u003e4\u003c/span\u003e\u003cspan class=\"k\"\u003e))\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"chroot\"\u003eChroot\u003c/h2\u003e\n\u003cp\u003eInstead of doing a regular chroot use \u003ccode\u003esystemd-nspawn\u003c/code\u003e which gives you a more fully featured chroot.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://wiki.archlinux.org/index.php/Systemd-nspawn\"\u003ehttps://wiki.archlinux.org/index.php/Systemd-nspawn\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"debugging-with-gdb\"\u003eDebugging With GDB\u003c/h2\u003e\n\u003cp\u003eIf you are lucky enough to be working on something thats in a VM you can get\nGDB working!\u003c/p\u003e\n\u003cp\u003eYou need to run the kernel without KASLR (on the cmdline thats \u003ccode\u003enokaslr\u003c/code\u003e).\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eIf you don't disable KASLR gdb can't set breakpoints or display the source to you\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eThen you run QEMU with \u003ccode\u003e-s -S\u003c/code\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e-s\u003c/code\u003e says enable GDB on port \u003ccode\u003e1234\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e-S\u003c/code\u003e says wait to start the VM until GDB connects.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eRun GDB with \u003ccode\u003egdb ./vmlinux\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eNow run\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e(gdb) target remote 127.0.0.1:1234\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eTo view the source code, type \u003ccode\u003elayout src\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eTo focus back on the typey type window, type \u003ccode\u003efocus cmd\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-c\" data-lang=\"c\"\u003e   \u003cspan class=\"err\"\u003e┌──\u003c/span\u003e\u003cspan class=\"n\"\u003earch\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003ex86\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003ekernel\u003c/span\u003e\u003cspan class=\"o\"\u003e/\u003c/span\u003e\u003cspan class=\"n\"\u003emachine_kexec_64\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"err\"\u003e─────────────────────────────────────────────────────────────────┐\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e353\u003c/span\u003e                 \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e                                                                      \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e354\u003c/span\u003e                         \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e                                                           \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e355\u003c/span\u003e                                                                                                  \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e356\u003c/span\u003e                 \u003cspan class=\"cm\"\u003e/* update purgatory as needed */\u003c/span\u003e                                                 \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e357\u003c/span\u003e                 \u003cspan class=\"n\"\u003eresult\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003earch_update_purgatory\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e                                           \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e358\u003c/span\u003e                 \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e                                                                      \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e359\u003c/span\u003e                         \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e                                                           \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e360\u003c/span\u003e                                                                                                  \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e361\u003c/span\u003e                 \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e                                                                        \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e362\u003c/span\u003e         \u003cspan class=\"p\"\u003e}\u003c/span\u003e                                                                                        \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e363\u003c/span\u003e                                                                                                  \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e364\u003c/span\u003e         \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003emachine_kexec_cleanup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ekimage\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e                                         \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e365\u003c/span\u003e         \u003cspan class=\"p\"\u003e{\u003c/span\u003e                                                                                        \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e366\u003c/span\u003e                 \u003cspan class=\"n\"\u003efree_transition_pgtable\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e                                                  \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e367\u003c/span\u003e         \u003cspan class=\"p\"\u003e}\u003c/span\u003e                                                                                        \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e368\u003c/span\u003e                                                                                                  \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e369\u003c/span\u003e         \u003cspan class=\"cm\"\u003e/*                                                                                       │\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e   │370          * Do not allocate memory (or fail in any way) in machine_kexec().                       │\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e   │371          * We are past the point of no return, committed to rebooting now.                       │\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e   │372          */\u003c/span\u003e                                                                                      \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e373\u003c/span\u003e         \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"n\"\u003emachine_kexec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ekimage\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eimage\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e                                                 \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n\u003cspan class=\"n\"\u003eB\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u0026gt;\u003c/span\u003e\u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e374\u003c/span\u003e         \u003cspan class=\"p\"\u003e{\u003c/span\u003e                                                                                        \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e375\u003c/span\u003e                 \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003epage_list\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ePAGES_NR\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e                                               \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e376\u003c/span\u003e                 \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003econtrol_page\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e                                                              \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e377\u003c/span\u003e                 \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esave_ftrace_enabled\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e                                                         \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e378\u003c/span\u003e                                                                                                  \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e379\u003c/span\u003e         \u003cspan class=\"err\"\u003e#\u003c/span\u003e\u003cspan class=\"n\"\u003eifdef\u003c/span\u003e \u003cspan class=\"n\"\u003eCONFIG_KEXEC_JUMP\u003c/span\u003e                                                                 \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e380\u003c/span\u003e                 \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimage\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003epreserve_context\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e                                                     \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e381\u003c/span\u003e                         \u003cspan class=\"n\"\u003esave_processor_state\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e                                                  \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e382\u003c/span\u003e         \u003cspan class=\"err\"\u003e#\u003c/span\u003e\u003cspan class=\"n\"\u003eendif\u003c/span\u003e                                                                                   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e383\u003c/span\u003e                                                                                                  \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e384\u003c/span\u003e                 \u003cspan class=\"n\"\u003esave_ftrace_enabled\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e__ftrace_enabled_save\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e                                   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e385\u003c/span\u003e                                                                                                  \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e386\u003c/span\u003e                 \u003cspan class=\"cm\"\u003e/* Interrupts aren\u0026#39;t acceptable while we reboot */\u003c/span\u003e                               \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e387\u003c/span\u003e                 \u003cspan class=\"n\"\u003elocal_irq_disable\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e                                                             \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e388\u003c/span\u003e                 \u003cspan class=\"n\"\u003ehw_breakpoint_disable\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e                                                         \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e389\u003c/span\u003e                                                                                                  \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e390\u003c/span\u003e                 \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eimage\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003epreserve_context\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e                                                   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e391\u003c/span\u003e         \u003cspan class=\"err\"\u003e#\u003c/span\u003e\u003cspan class=\"n\"\u003eifdef\u003c/span\u003e \u003cspan class=\"n\"\u003eCONFIG_X86_IO_APIC\u003c/span\u003e                                                                \u003cspan class=\"err\"\u003e│\u003c/span\u003e\n   \u003cspan class=\"err\"\u003e│\u003c/span\u003e\u003cspan class=\"mi\"\u003e392\u003c/span\u003e                         \u003cspan class=\"cm\"\u003e/*                                                                       │\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e   │393                          * We need to put APICs in legacy mode so that we can                    │\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e   │394                          * get timer interrupts in second kernel. kexec/kdump                    │\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e   │395                          * paths already have calls to restore_boot_irq_mode()                   │\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e   │396                          * in one form or other. kexec jump path also need one.                  │\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e   └─────────────────────────────────────────────────────────────────────────────────────────────────────┘\n\u003c/span\u003e\u003cspan class=\"cm\"\u003eremote Thread 1.1 In: machine_kexec                                          L374  PC: 0xffffffff810635f0\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e(gdb) b *machine_kexec\n\u003c/span\u003e\u003cspan class=\"cm\"\u003eBreakpoint 1 at 0xffffffff810635f0: file arch/x86/kernel/machine_kexec_64.c, line 374.\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e(gdb) c\n\u003c/span\u003e\u003cspan class=\"cm\"\u003eContinuing.\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e\n\u003c/span\u003e\u003cspan class=\"cm\"\u003eBreakpoint 1, machine_kexec (image=0xffff888006f96800) at arch/x86/kernel/machine_kexec_64.c:374\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e(gdb)\n\u003c/span\u003e\u003cspan class=\"cm\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"kvm\"\u003eKVM\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://lwn.net/Articles/658511/\"\u003ehttps://lwn.net/Articles/658511/\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"nested-and-vmcs\"\u003eNested and VMCS\u003c/h3\u003e\n\u003cp\u003e\u003ca href=\"https://web.archive.org/web/20191105205408/http://events19.linuxfoundation.org/wp-content/uploads/2017/12/Improving-KVM-x86-Nested-Virtualization-Liran-Alon-Oracle.pdf\"\u003ehttps://web.archive.org/web/20191105205408/http://events19.linuxfoundation.org/wp-content/uploads/2017/12/Improving-KVM-x86-Nested-Virtualization-Liran-Alon-Oracle.pdf\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"contributions\"\u003eContributions\u003c/h2\u003e\n\u003cp\u003eIn your patches, write all about what you're doing. The kernel doesn't\nseem to like comments very much. Instead they rely on people writing\ninsanely detailed commit messages describing what they are changing.\u003c/p\u003e\n\u003cp\u003eEvery time you change the kernel you're changing something that has been\nworking fine for someone for X amount of long time. As such, you need to\nbe convincing for why your change should be accepted! Make your coverletter\nand commit messages very detailed. The kernel is a big place. It may have\nbeen a long time since someone reading your patch series has looked at the\nplace you're working. Be courtious and remind them of all the moving peices\ninvolved in what you're doing, and why and how you're changing them.\u003c/p\u003e\n\u003ch3 id=\"etiquette\"\u003eEtiquette\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eYou can say \u003ccode\u003epatch\u003c/code\u003e or \u003ccode\u003epatchset\u003c/code\u003e in your coverletter. Just not in the\ncommit messages themselves.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"kvm-1\"\u003eKVM\u003c/h2\u003e\n\u003ch3 id=\"vmx\"\u003eVMX\u003c/h3\u003e\n\u003cp\u003eWhen a VM enters VMX root mode (aka \u0026quot;I'm gonna run some VMs mode\u0026quot;) using\nthe \u003ccode\u003eVMXON\u003c/code\u003e instruction, it sets up what's called a \u003ccode\u003eVMCS\u003c/code\u003e for each VM\n/ virtualized processor it wants to run. All VMX related instructions\noperate on whatever VMCS we pointed to via the \u003ccode\u003eVMPTRLD\u003c/code\u003e instruction.\u003c/p\u003e\n\u003ch3 id=\"nested\"\u003eNested\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eL0 == The host\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eL1 == The guest\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eL2 == The guest of the guest\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ccode\u003evmx/nested.c\u003c/code\u003e is responsible for emulating VMX for L1. When L1 does a\n\u003ccode\u003eVMLAUNCH\u003c/code\u003e or \u003ccode\u003eVMRESUME\u003c/code\u003e, \u003ccode\u003eenter_guest_mode\u003c/code\u003e is called, which means that\n\u003ccode\u003eis_guest_mode\u003c/code\u003e will now return \u003ccode\u003etrue\u003c/code\u003e.\u003c/p\u003e\n\u003ch2 id=\"assembly\"\u003eAssembly\u003c/h2\u003e\n\u003cp\u003eWhat is \u003ccode\u003ejmp 1f\u003c/code\u003e?\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://stackoverflow.com/a/27353169/12310488\"\u003ehttps://stackoverflow.com/a/27353169/12310488\u003c/a\u003e\u003c/p\u003e"}</script><link rel=preload as=script href="/bundle.js?v=1595572978"><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://stats.g.doubleclick.net><link rel=preconnect href=https://www.googleadservices.com><link rel=preload as=script href="https://www.googletagmanager.com/gtag/js?id=UA-160259978-2"><script src="https://www.googletagmanager.com/gtag/js?id=UA-160259978-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-160259978-2');</script></head><body><header id=nav class=header><div class="ax-l-i max-w-6xl"><div class=ax-logo><a class=block href=/ title="pdxjohnny's blog"><img src=/images/avatar@2x.png alt="pdxjohnny's blog"></a></div><div class=ax-user><a class="p-2 w-8 h-8 block text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" target=_blank rel="noopener nofollow" href="https://www.google.com/search?q=site:chadig.com" title=Search><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.67 12.804c0-5.6 4.544-10.134 10.133-10.134s10.134 4.544 10.134 10.134-4.544 10.133-10.134 10.133S2.67 18.393 2.67 12.804zm28.943 16.923-8.868-8.868c4.287-5.3 3.68-13.012-1.378-17.57S8.564-1.066 3.75 3.75s-5.017 12.558-.46 17.618 12.28 5.665 17.57 1.378l8.868 8.868a1.33 1.33.0 002.231-.597c.123-.46-.008-.952-.345-1.29h0z"/></svg></a><a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href=/about/>About</a></div></div></header><main><div class=default-single><div class="ax-title ax-l-o"><div class="ax-l-i max-w-680"><h1 class="post-title font-content-title font-normal leading-tight tracking-default text-40">Linux Kernel Tips And Tricks</h1><p class="post-subtitle font-content-sans font-light text-xl text-raven-500 mt-3">Working on the Linux kernel itself</p><div class="ax-meta flex items-center mt-5"><div class="flex-grow min-w-0"><div class="flex items-center"><div class=flex-shrink-0><img class="w-12 h-12 sm:w-14 sm:h-14 object-cover p-05 rounded-full border border-blue-300" src=/images/avatar@2x.png alt="John Andersen"></div><div class="flex-shrink-0 ml-2 leading-tight font-content-sans"><a class="block text-sm text-raven-800 hover:text-raven-900 hover:underline focus:underline" target=_blank rel="noopener nofollow" title="John Andersen" href=https://pdxjohnny.github.io/>John Andersen</a>
<time class="text-sm text-raven-500" datetime=2020-07-24T06:00:00Z>Jul 24, 2020 6:00AM</time></div></div></div><div><div class="flex items-center"><a class="flex-shrink-0 block text-raven-800 hover:text-raven-900" target=_blank rel="noopener nofollow" title="Share on Twitter" href="https://twitter.com/intent/tweet?text=Linux%20Kernel%20Tips%20And%20Tricks%20by%20%40pdxjohnny%20https%3a%2f%2fpdxjohnny.github.io%2fpost%2flinux-kernel%2f"><svg class="w-6 h-6 fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11.0 01-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56.0 00-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57.0 002.914 5.452 6.48 6.48.0 01-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42.0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18.0 01-8.134 2.798c-.538.0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072.0 18.672-10 18.672-18.668.0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg></a><a class="ml-3 flex-shrink-0 block text-raven-800 hover:text-raven-900" target=_blank rel="noopener nofollow" title="Share on Facebook" href="https://www.facebook.com/dialog/share?app_id=&display=page&href=https%3a%2f%2fpdxjohnny.github.io%2fpost%2flinux-kernel%2f"><svg class="w-6 h-6 fill-current" viewBox="-7 -3.5 39 39" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M30.234.0H1.765C.8.001.0.79.0 1.766v28.47C.001 31.2.79 32 1.766 32h15.328V19.625h-4.156V14.78h4.156v-3.564c0-4.134 2.523-6.384 6.21-6.384 1.766.0 3.284.13 3.726.2v4.32h-2.543c-2.006.0-2.394.953-2.394 2.352v3.085h4.797l-.625 4.844h-4.172V32h8.14C31.21 32 32 31.2 32 30.234V1.765C32 .8 31.21.0 30.234.0z"/></svg></a></div></div></div></div></div><div class="ax-content ax-l-o"><div class="ax-l-i max-w-680"><article class=cdata><h2 id=debugging>Debugging</h2><p>Core dumps and kgdb: <a href=https://elinux.org/images/f/f0/Bingham.pdf>https://elinux.org/images/f/f0/Bingham.pdf</a></p><h2 id=exploitation>Exploitation</h2><p>SMEP disable via ROP, KASLR bypasss via DMESG</p><ul><li><a href=https://web.archive.org/web/20171029060939/http://www.blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/>https://web.archive.org/web/20171029060939/http://www.blackbunny.io/linux-kernel-x86-64-bypass-smep-kaslr-kptr_restric/</a></li></ul><h2 id=hacking-with-vim>Hacking With VIM</h2><p><a href=https://stackoverflow.com/questions/33676829/vim-configuration-for-linux-kernel-development>https://stackoverflow.com/questions/33676829/vim-configuration-for-linux-kernel-development</a></p><h2 id=build-in-tree-modules>Build In Tree Modules</h2><pre><code class=language-console data-lang=console>make -j $(($(nproc)*4)) M=arch/x86/kvm/ modules
</code></pre><h2 id=install-kernel-to-chroot>Install Kernel To chroot</h2><p>Here's how you install a kernel to a chroot. Or tar it up and
send it over to another system for use there.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># Edit your config</span>
make olddefconfig
<span class=nb>export</span> <span class=nv>INSTALL_MOD_PATH</span><span class=o>=</span>/path/to/your/chroot
<span class=nb>export</span> <span class=nv>INSTALL_PATH</span><span class=o>=</span><span class=si>${</span><span class=nv>INSTALL_MOD_PATH</span><span class=si>}</span>/boot
mkdir -p <span class=s2>&#34;</span><span class=si>${</span><span class=nv>INSTALL_PATH</span><span class=si>}</span><span class=s2>&#34;</span>
<span class=c1># Use number of cores times 4, this usually is about how many</span>
<span class=c1># threads your system can run</span>
make -j <span class=k>$(($(</span>nproc<span class=k>)</span><span class=o>*</span><span class=m>4</span><span class=k>))</span>
make install
make modules_install -j <span class=k>$(($(</span>nproc<span class=k>)</span><span class=o>*</span><span class=m>4</span><span class=k>))</span>
</code></pre></div><h2 id=chroot>Chroot</h2><p>Instead of doing a regular chroot use <code>systemd-nspawn</code> which gives you a more fully featured chroot.</p><p><a href=https://wiki.archlinux.org/index.php/Systemd-nspawn>https://wiki.archlinux.org/index.php/Systemd-nspawn</a></p><h2 id=debugging-with-gdb>Debugging With GDB</h2><p>If you are lucky enough to be working on something thats in a VM you can get
GDB working!</p><p>You need to run the kernel without KASLR (on the cmdline thats <code>nokaslr</code>).</p><blockquote><p>If you don't disable KASLR gdb can't set breakpoints or display the source to you</p></blockquote><p>Then you run QEMU with <code>-s -S</code>.</p><ul><li><code>-s</code> says enable GDB on port <code>1234</code></li><li><code>-S</code> says wait to start the VM until GDB connects.</li></ul><p>Run GDB with <code>gdb ./vmlinux</code></p><p>Now run</p><pre><code class=language-console data-lang=console>(gdb) target remote 127.0.0.1:1234
</code></pre><p>To view the source code, type <code>layout src</code></p><p>To focus back on the typey type window, type <code>focus cmd</code></p><div class=highlight><pre class=chroma><code class=language-c data-lang=c>   <span class=err>┌──</span><span class=n>arch</span><span class=o>/</span><span class=n>x86</span><span class=o>/</span><span class=n>kernel</span><span class=o>/</span><span class=n>machine_kexec_64</span><span class=p>.</span><span class=n>c</span><span class=err>─────────────────────────────────────────────────────────────────┐</span>
   <span class=err>│</span><span class=mi>353</span>                 <span class=k>if</span> <span class=p>(</span><span class=n>result</span><span class=p>)</span>                                                                      <span class=err>│</span>
   <span class=err>│</span><span class=mi>354</span>                         <span class=k>return</span> <span class=n>result</span><span class=p>;</span>                                                           <span class=err>│</span>
   <span class=err>│</span><span class=mi>355</span>                                                                                                  <span class=err>│</span>
   <span class=err>│</span><span class=mi>356</span>                 <span class=cm>/* update purgatory as needed */</span>                                                 <span class=err>│</span>
   <span class=err>│</span><span class=mi>357</span>                 <span class=n>result</span> <span class=o>=</span> <span class=n>arch_update_purgatory</span><span class=p>(</span><span class=n>image</span><span class=p>);</span>                                           <span class=err>│</span>
   <span class=err>│</span><span class=mi>358</span>                 <span class=k>if</span> <span class=p>(</span><span class=n>result</span><span class=p>)</span>                                                                      <span class=err>│</span>
   <span class=err>│</span><span class=mi>359</span>                         <span class=k>return</span> <span class=n>result</span><span class=p>;</span>                                                           <span class=err>│</span>
   <span class=err>│</span><span class=mi>360</span>                                                                                                  <span class=err>│</span>
   <span class=err>│</span><span class=mi>361</span>                 <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>                                                                        <span class=err>│</span>
   <span class=err>│</span><span class=mi>362</span>         <span class=p>}</span>                                                                                        <span class=err>│</span>
   <span class=err>│</span><span class=mi>363</span>                                                                                                  <span class=err>│</span>
   <span class=err>│</span><span class=mi>364</span>         <span class=kt>void</span> <span class=n>machine_kexec_cleanup</span><span class=p>(</span><span class=k>struct</span> <span class=n>kimage</span> <span class=o>*</span><span class=n>image</span><span class=p>)</span>                                         <span class=err>│</span>
   <span class=err>│</span><span class=mi>365</span>         <span class=p>{</span>                                                                                        <span class=err>│</span>
   <span class=err>│</span><span class=mi>366</span>                 <span class=n>free_transition_pgtable</span><span class=p>(</span><span class=n>image</span><span class=p>);</span>                                                  <span class=err>│</span>
   <span class=err>│</span><span class=mi>367</span>         <span class=p>}</span>                                                                                        <span class=err>│</span>
   <span class=err>│</span><span class=mi>368</span>                                                                                                  <span class=err>│</span>
   <span class=err>│</span><span class=mi>369</span>         <span class=cm>/*                                                                                       │
</span><span class=cm>   │370          * Do not allocate memory (or fail in any way) in machine_kexec().                       │
</span><span class=cm>   │371          * We are past the point of no return, committed to rebooting now.                       │
</span><span class=cm>   │372          */</span>                                                                                      <span class=err>│</span>
   <span class=err>│</span><span class=mi>373</span>         <span class=kt>void</span> <span class=n>machine_kexec</span><span class=p>(</span><span class=k>struct</span> <span class=n>kimage</span> <span class=o>*</span><span class=n>image</span><span class=p>)</span>                                                 <span class=err>│</span>
<span class=n>B</span><span class=o>+&gt;</span><span class=err>│</span><span class=mi>374</span>         <span class=p>{</span>                                                                                        <span class=err>│</span>
   <span class=err>│</span><span class=mi>375</span>                 <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>page_list</span><span class=p>[</span><span class=n>PAGES_NR</span><span class=p>];</span>                                               <span class=err>│</span>
   <span class=err>│</span><span class=mi>376</span>                 <span class=kt>void</span> <span class=o>*</span><span class=n>control_page</span><span class=p>;</span>                                                              <span class=err>│</span>
   <span class=err>│</span><span class=mi>377</span>                 <span class=kt>int</span> <span class=n>save_ftrace_enabled</span><span class=p>;</span>                                                         <span class=err>│</span>
   <span class=err>│</span><span class=mi>378</span>                                                                                                  <span class=err>│</span>
   <span class=err>│</span><span class=mi>379</span>         <span class=err>#</span><span class=n>ifdef</span> <span class=n>CONFIG_KEXEC_JUMP</span>                                                                 <span class=err>│</span>
   <span class=err>│</span><span class=mi>380</span>                 <span class=k>if</span> <span class=p>(</span><span class=n>image</span><span class=o>-&gt;</span><span class=n>preserve_context</span><span class=p>)</span>                                                     <span class=err>│</span>
   <span class=err>│</span><span class=mi>381</span>                         <span class=n>save_processor_state</span><span class=p>();</span>                                                  <span class=err>│</span>
   <span class=err>│</span><span class=mi>382</span>         <span class=err>#</span><span class=n>endif</span>                                                                                   <span class=err>│</span>
   <span class=err>│</span><span class=mi>383</span>                                                                                                  <span class=err>│</span>
   <span class=err>│</span><span class=mi>384</span>                 <span class=n>save_ftrace_enabled</span> <span class=o>=</span> <span class=n>__ftrace_enabled_save</span><span class=p>();</span>                                   <span class=err>│</span>
   <span class=err>│</span><span class=mi>385</span>                                                                                                  <span class=err>│</span>
   <span class=err>│</span><span class=mi>386</span>                 <span class=cm>/* Interrupts aren&#39;t acceptable while we reboot */</span>                               <span class=err>│</span>
   <span class=err>│</span><span class=mi>387</span>                 <span class=n>local_irq_disable</span><span class=p>();</span>                                                             <span class=err>│</span>
   <span class=err>│</span><span class=mi>388</span>                 <span class=n>hw_breakpoint_disable</span><span class=p>();</span>                                                         <span class=err>│</span>
   <span class=err>│</span><span class=mi>389</span>                                                                                                  <span class=err>│</span>
   <span class=err>│</span><span class=mi>390</span>                 <span class=k>if</span> <span class=p>(</span><span class=n>image</span><span class=o>-&gt;</span><span class=n>preserve_context</span><span class=p>)</span> <span class=p>{</span>                                                   <span class=err>│</span>
   <span class=err>│</span><span class=mi>391</span>         <span class=err>#</span><span class=n>ifdef</span> <span class=n>CONFIG_X86_IO_APIC</span>                                                                <span class=err>│</span>
   <span class=err>│</span><span class=mi>392</span>                         <span class=cm>/*                                                                       │
</span><span class=cm>   │393                          * We need to put APICs in legacy mode so that we can                    │
</span><span class=cm>   │394                          * get timer interrupts in second kernel. kexec/kdump                    │
</span><span class=cm>   │395                          * paths already have calls to restore_boot_irq_mode()                   │
</span><span class=cm>   │396                          * in one form or other. kexec jump path also need one.                  │
</span><span class=cm>   └─────────────────────────────────────────────────────────────────────────────────────────────────────┘
</span><span class=cm>remote Thread 1.1 In: machine_kexec                                          L374  PC: 0xffffffff810635f0
</span><span class=cm>(gdb) b *machine_kexec
</span><span class=cm>Breakpoint 1 at 0xffffffff810635f0: file arch/x86/kernel/machine_kexec_64.c, line 374.
</span><span class=cm>(gdb) c
</span><span class=cm>Continuing.
</span><span class=cm>
</span><span class=cm>Breakpoint 1, machine_kexec (image=0xffff888006f96800) at arch/x86/kernel/machine_kexec_64.c:374
</span><span class=cm>(gdb)
</span><span class=cm>
</span></code></pre></div><h2 id=kvm>KVM</h2><p><a href=https://lwn.net/Articles/658511/>https://lwn.net/Articles/658511/</a></p><h3 id=nested-and-vmcs>Nested and VMCS</h3><p><a href=https://web.archive.org/web/20191105205408/http://events19.linuxfoundation.org/wp-content/uploads/2017/12/Improving-KVM-x86-Nested-Virtualization-Liran-Alon-Oracle.pdf>https://web.archive.org/web/20191105205408/http://events19.linuxfoundation.org/wp-content/uploads/2017/12/Improving-KVM-x86-Nested-Virtualization-Liran-Alon-Oracle.pdf</a></p><h2 id=contributions>Contributions</h2><p>In your patches, write all about what you're doing. The kernel doesn't
seem to like comments very much. Instead they rely on people writing
insanely detailed commit messages describing what they are changing.</p><p>Every time you change the kernel you're changing something that has been
working fine for someone for X amount of long time. As such, you need to
be convincing for why your change should be accepted! Make your coverletter
and commit messages very detailed. The kernel is a big place. It may have
been a long time since someone reading your patch series has looked at the
place you're working. Be courtious and remind them of all the moving peices
involved in what you're doing, and why and how you're changing them.</p><h3 id=etiquette>Etiquette</h3><ul><li>You can say <code>patch</code> or <code>patchset</code> in your coverletter. Just not in the
commit messages themselves.</li></ul><h2 id=kvm-1>KVM</h2><h3 id=vmx>VMX</h3><p>When a VM enters VMX root mode (aka "I'm gonna run some VMs mode") using
the <code>VMXON</code> instruction, it sets up what's called a <code>VMCS</code> for each VM
/ virtualized processor it wants to run. All VMX related instructions
operate on whatever VMCS we pointed to via the <code>VMPTRLD</code> instruction.</p><h3 id=nested>Nested</h3><ul><li><p>L0 == The host</p></li><li><p>L1 == The guest</p></li><li><p>L2 == The guest of the guest</p></li></ul><p><code>vmx/nested.c</code> is responsible for emulating VMX for L1. When L1 does a
<code>VMLAUNCH</code> or <code>VMRESUME</code>, <code>enter_guest_mode</code> is called, which means that
<code>is_guest_mode</code> will now return <code>true</code>.</p><h2 id=assembly>Assembly</h2><p>What is <code>jmp 1f</code>?</p><p><a href=https://stackoverflow.com/a/27353169/12310488>https://stackoverflow.com/a/27353169/12310488</a></p></article></div></div></div></main><footer class=footer><div class="ax-l-i max-w-6xl"><nav class="flex items-center justify-center"><a class="ml-3 first:ml-0 text-sm text-gray-600 hover:text-gray-800" href=/about/>About</a></nav><div class="footer-social flex items-center justify-center mt-4"><a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target=_blank rel="noopener nofollow" title=Twitter href=https://twitter.com/pdxjohnny><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11.0 01-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56.0 00-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57.0 002.914 5.452 6.48 6.48.0 01-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42.0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18.0 01-8.134 2.798c-.538.0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072.0 18.672-10 18.672-18.668.0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg></a><a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target=_blank rel="noopener nofollow" title=Github href=https://github.com/pdxjohnny><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M15.998.0C7.164.0.0 7.35.0 16.417.0 23.67 4.584 29.82 10.944 31.994c.8.15 1.092-.356 1.092-.79l-.022-2.792c-4.45.99-5.4-2.202-5.4-2.202-.726-1.896-1.776-2.4-1.776-2.4-1.454-1.018.108-.998.108-.998 1.606.117 2.45 1.693 2.45 1.693 1.428 2.507 3.746 1.784 4.658 1.363.144-1.06.558-1.784 1.016-2.195-3.552-.415-7.288-1.823-7.288-8.113.0-1.792.624-3.258 1.648-4.406-.166-.415-.714-2.085.156-4.344.0.0 1.344-.44 4.4 1.683 1.276-.364 2.644-.546 4.006-.552a14.98 14.98.0 014.006.554C23.062 6.37 24.404 6.8 24.404 6.8c.872 2.26.324 3.93.16 4.344 1.026 1.148 1.644 2.614 1.644 4.406.0 6.306-3.74 7.694-7.304 8.1.574.507 1.086 1.51 1.086 3.04l-.02 4.503c0 .44.288.95 1.1.788C27.42 29.817 32 23.667 32 16.417 32 7.35 24.836.0 15.998.0z"/></svg></a><a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target=_blank rel="noopener nofollow" title=LinkedIn href=https://www.linkedin.com/in/john-andersen-7a72b555/><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M29.692.0H2.308A2.31 2.31.0 000 2.308v27.384A2.31 2.31.0 002.308 32h27.384A2.31 2.31.0 0032 29.692V2.308A2.31 2.31.0 0029.692.0zM11.35 24.188H7.454V12.464h3.897v11.723zM9.402 10.863h-.025c-1.308.0-2.153-.9-2.153-2.025.0-1.15.872-2.026 2.205-2.026s2.153.875 2.18 2.026c0 1.125-.846 2.025-2.205 2.025zm16 13.324h-3.896v-6.272c0-1.576-.564-2.65-1.974-2.65-1.076.0-1.717.725-2 1.425-.103.25-.128.6-.128.95v6.547h-3.896V12.464h3.896v1.66c.518-.8 1.444-1.935 3.512-1.935 2.564.0 4.486 1.676 4.486 5.276v6.722z"/></svg></a></div><div class="footer-copyright text-sm text-center text-gray-500 mt-4">&#169; 2016-2020 pdxjohnny's blog</div><div class="text-sm sm:text-xs text-center text-gray-500 mt-2">Powered by <a href="https://www.axiomtheme.com/?utm_source=theme-footer&utm_medium=website&utm_campaign=referral">Axiom</a></div></div></footer><script src="/bundle.js?v=1595572978"></script></body></html>